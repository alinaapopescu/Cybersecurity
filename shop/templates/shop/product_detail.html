{% extends "shop/base.html" %}
{% load static %}

{% block title %}{{ product.name }} - Detalii produs{% endblock %}

{% block content %}
<div class="card mb-4">
  {% if product.image %}
    <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
  {% else %}
    <img src="{% static 'shop/no_image_available.png' %}" class="card-img-top" alt="FÄƒrÄƒ imagine">
  {% endif %}
  <div class="card-body">
    <h3 class="card-title">{{ product.name }}</h3>
    <p class="card-text">{{ product.description }}</p>
    <p class="card-text"><strong>PreÈ›: </strong>{{ product.price }} RON</p>
    {% if product.stock > 0 %}
      {% if product.stock <= 3 %}
        <p class="text-danger"><strong>Stoc limitat: {{ product.stock }}</strong></p>
      {% else %}
        <p class="text-success"><strong>Stoc: {{ product.stock }}</strong></p>
      {% endif %}
    {% else %}
      <p class="text-muted">Produsul nu mai este Ã®n stoc.</p>
    {% endif %}
    <a href="{% url 'shop:add_to_cart' product.id %}" class="btn btn-success mt-2">CumpÄƒrÄƒ</a>
  </div>
</div>

<hr>

<h4>ðŸ’¬ Comentarii</h4>

{% if comments %}
  <ul class="list-group mb-4">
    {% for comment in comments %}
      <li class="list-group-item">
        <div class="d-flex justify-content-between">
          <strong>{{ comment.user.username }}</strong>
          <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
        </div>
        <!-- Zona unde se va afiÈ™a comentariul decodat -->
        <div id="comment-{{ comment.id }}"></div>
        <script>
          // FuncÈ›ie de decodificare complexÄƒ Ã®n JavaScript:
          function complexDecode(encoded, shift) {
            // Step 1: Base64 decode
            let ciphered = atob(encoded);
            // Step 2: Reverse Caesar cipher pentru caracterele imprimabile (ASCII 32-126)
            let deciphered = "";
            for (let i = 0; i < ciphered.length; i++) {
              let code = ciphered.charCodeAt(i);
              if (code >= 32 && code <= 126) {
                let newCode = code - shift;
                if (newCode < 32) {
                  newCode += 95;
                }
                deciphered += String.fromCharCode(newCode);
              } else {
                deciphered += ciphered.charAt(i);
              }
            }
            // Step 3: Reverse string
            return deciphered.split("").reverse().join("");
          }

          // ObÈ›ine valoarea comentariului codificat din contextul template-ului (escapejs pentru siguranÈ›Äƒ)
          var encodedText = "{{ comment.text|escapejs }}";
          var decodedText = complexDecode(encodedText, 5);
          // InserÄƒm rezultat prin innerHTML (aceasta este vulnerabilitate XSS intenÈ›ionatÄƒ)
          document.getElementById("comment-{{ comment.id }}").innerHTML = decodedText;
        </script>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>Nu existÄƒ comentarii la acest produs.</p>
{% endif %}

{% if comment_form %}
  <h5>LasÄƒ un comentariu</h5>
  <form method="post">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button type="submit" class="btn btn-primary">Trimite comentariul</button>
  </form>
{% elif message %}
  <div class="alert alert-info mt-3">{{ message }}</div>
{% endif %}
{% endblock %}
